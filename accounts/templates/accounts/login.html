{% extends 'base.html' %}
{% load static %}

{% load django_bootstrap5 %}
{% block content %}
<div class="login-frame">
  <div class="login-frame__form">
    <img class="login-frame__form__img" src="{% static 'images/nes_orange.png' %}" alt="">
    <form id="login-form">
      {% csrf_token %}
      <input class="login-frame__form__id" type="text" name="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.">
      <input class="login-frame__form__password" type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.">
      <button class="login-frame__form__logbtn">ë¡œê·¸ì¸</button>
    </form>
    <a href="http://nes-env.eba-9ycvw3yi.ap-northeast-2.elasticbeanstalk.com/accounts/login/kakao/">
      <button class="login-frame__form__googlebtn">ğŸ³ CONTINUE WITH KAKAO</button>
    </a>
    <div class="login-frame__form__detail">
      <div class="login-frame_-form__detail__find">
        <a href="" id="id-find-btn">ì•„ì´ë”” ì°¾ê¸°</a>
        |
        <a href="" id="pw-find-btn">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
      </div>
      <div class="login-frame__form__detail__signup">
        <a href="{% url 'accounts:signup'%}">íšŒì›ê°€ì…</a>
      </div>
    </div>
  </div>
</div>
<script>
  const loginForm = document.querySelector("#login-form");
  loginForm.addEventListener("submit", function (event) {
    event.preventDefault();
    axios({
      method: "post",
      url: `/accounts/login/`,
      data: new FormData(loginForm)
    })
      .then(response => {
        let msg = response.data.errorMsg;
        if (msg) {
          if (msg === "ì˜ëª»ëœ ì•„ì´ë”” í˜¹ì€ íŒ¨ìŠ¤ì›Œë“œ ì…ë‹ˆë‹¤.") {
            let titleText = "ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤."
            let iconText = "error"
            swal.fire({
              backdrop: "rgba(255,255,255,0.5)",
              confirmButtonColor: '#203e96',
              confirmButtonText: 'ë‹«ê¸°',
              title: titleText,
              text: msg,
              icon: iconText,
            });
          } else if (msg === "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íšŒì›ì…ë‹ˆë‹¤.") {
            let titleText = "ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            let iconText = "question"
            swal.fire({
              backdrop: "rgba(255,255,255,0.5)",
              confirmButtonColor: '#203e96',
              confirmButtonText: 'ë‹«ê¸°',
              title: titleText,
              text: msg,
              icon: iconText,
            });
          };
          loginForm.reset();
        } else {
          window.location.href = "{% url 'articles:ticket_machine' %}";
        };
      });
  });
</script>
<script>
  const idFindBtn = document.querySelector("#id-find-btn");
  const pwFindBtn = document.querySelector("#pw-find-btn");

  idFindBtn.addEventListener("click", function (event) {
    event.preventDefault();
    Swal.fire({
      backdrop: "rgba(255,255,255,0.5)",
      showCancelButton: true,
      showLoaderOnConfirm: true,
      confirmButtonText: 'ì°¾ê¸°',
      confirmButtonColor: '#f3672a',
      cancelButtonText: 'ë‹«ê¸°',
      cancelButtonColor: '#203e96',
      icon: 'info',
      title: 'ì•„ì´ë”” ì°¾ê¸°',
      input: 'text',
      text: 'ê°€ì…ì‹œ ì‘ì„±í•˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.',
      inputAttributes: {
        autocapitalize: 'off'
      },
      preConfirm: (email) => {
        if (email === "") {
          Swal.fire({
            backdrop: "rgba(255,255,255,0.5)",
            cancelButtonText: 'ë‹«ê¸°',
            cancelButtonColor: '#203e96',
            icon: 'warning',
            title: 'ì´ë©”ì¼ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
            text: 'ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”!',
          });
        } else {
          return axios({
            method: "get",
            url: `/accounts/find-id/?email=${email}`,
          }).then(response => {
            return response.data
          });
        };
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed && result.value !== "") {
        if (result.value.errorMsg !== undefined) {
          console.log(result.value.errorMsg);
          swal.fire({
            backdrop: "rgba(255,255,255,0.5)",
            confirmButtonColor: '#203e96',
            confirmButtonText: 'ë‹«ê¸°',
            title: "íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
            text: result.value.errorMsg,
            icon: "question",
          });
        } else {
          const userList = result.value.userList;
          let res = "";
          for (let i = 0; i < userList.length; i++) {
            res += String(userList[i]) + "<br>";
          };
          swal.fire({
            backdrop: "rgba(255,255,255,0.5)",
            confirmButtonColor: '#203e96',
            confirmButtonText: 'í™•ì¸',
            title: "ê²€ìƒ‰ ê²°ê³¼",
            html: `
            <p style="word-break: keep-all;">ê²€ìƒ‰í•˜ì‹  ì´ë©”ì¼ë¡œ ëª¨ë‘ <span style="color: #f3672a;">${result.value.userCount}</span> ê°œì˜ ì•„ì´ë””ê°€ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <p>${res}</p>
            `,
            icon: "success",
          });
        };
      };
    });
  });

  pwFindBtn.addEventListener("click", function (event) {
    event.preventDefault();
    Swal.fire({
      backdrop: "rgba(255,255,255,0.5)",
      showCancelButton: true,
      confirmButtonText: 'ì°¾ê¸°',
      confirmButtonColor: '#f3672a',
      cancelButtonText: 'ë‹«ê¸°',
      cancelButtonColor: '#203e96',
      icon: 'info',
      title: 'ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°',
      input: 'text',
      text: 'ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
      inputAttributes: {
        autocapitalize: 'off'
      },
      preConfirm: (username) => {
        if (username === "") {
          Swal.fire({
            backdrop: "rgba(255,255,255,0.5)",
            cancelButtonText: 'ë‹«ê¸°',
            cancelButtonColor: '#203e96',
            icon: 'warning',
            title: 'ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
            text: 'ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!',
          });
        } else {
          return axios({
            method: "get",
            url: `/accounts/find-pw/?username=${username}`,
          }).then(response => {
            if (response.data.errorMsg) {
              swal.fire({
                backdrop: "rgba(255,255,255,0.5)",
                confirmButtonColor: '#203e96',
                confirmButtonText: 'ë‹«ê¸°',
                title: "íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                text: response.data.errorMsg,
                icon: "question",
              });
            } else {
              Swal.fire({
                backdrop: "rgba(255,255,255,0.5)",
                html: `
                <div class="d-flex justify-content-center align-items-center" style="height: 10rem;">
                  <div class="spinner-border" role="status" style="width: 6rem; height: 6rem; color: #f3672a;">
                    <span class="visually-hidden">ë¡œë”©ì¤‘</span>
                  </div>
                </div>
                `,
                showConfirmButton: false,
              });
            };
            return response.data
          });
        };
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed && result.value !== "" && result.value.errorMsg === undefined) {
        let formData = new FormData();
        formData.append("user_email", result.value.userEmail);
        formData.append("user_name", result.value.userName);
        axios({
          method: 'post',
          url: `/accounts/find-pw-email/`,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          data: formData,
        }).then(response => {
          Swal.fire({
            backdrop: "rgba(255,255,255,0.5)",
            showCancelButton: true,
            showLoaderOnConfirm: true,
            cancelButtonText: 'ë‹«ê¸°',
            cancelButtonColor: '#203e96',
            confirmButtonColor: '#f3672a',
            confirmButtonText: 'í™•ì¸',
            html: `
            <h3 class="mb-3" style="word-break: keep-all; font-weight: bold;">ê°€ì…ì‹œ ì‘ì„±í•˜ì‹  ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</h3>
            <p class="mb-0" style="word-break: keep-all;">ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥ í›„ í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            `,
            input: 'text',
            inputAttributes: {
              autocapitalize: 'off'
            },
            preConfirm: (number) => {
              const validNum = response.data.validnumber;
              let userName = response.data.userName;
              let formData = new FormData();
              formData.append("inputNum", number);
              formData.append("validNum", validNum);
              formData.append("userName", userName);
              return axios({
                method: "post",
                url: `/accounts/find-pw-email-check/`,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                data: formData,
              }).then(response => {
                if (response.data.check === true) {
                  let userName = response.data.userName;
                  Swal.fire({
                    backdrop: "rgba(255,255,255,0.5)",
                    showCancelButton: true,
                    showLoaderOnConfirm: true,
                    title: 'ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
                    html: `
                    <form id="pw-change">
                      <label for="pw-change-1" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</label>
                      <input class="form-control" type="password" name="pw1" id="pw-change-1">
                      <label for="pw-change-2" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                      <input class="form-control" type="password" name="pw2" id="pw-change-2">
                      <input type=hidden value="${userName}" name="userName">
                    </form>
                    `,
                    text: 'ì…ë ¥ í›„ í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.',
                    cancelButtonText: 'ë‹«ê¸°',
                    cancelButtonColor: '#203e96',
                    confirmButtonColor: '#f3672a',
                    confirmButtonText: 'í™•ì¸',
                    preConfirm: (form) => {
                      const pwChangeForm = document.querySelector("#pw-change");
                      let formData = new FormData(pwChangeForm);
                      return axios({
                        method: "post",
                        url: `/accounts/pw-change/`,
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                        data: formData,
                      }).then(response => {
                        if (response.data.msg === "ë³€ê²½ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.") {
                          Swal.fire({
                            backdrop: "rgba(255,255,255,0.5)",
                            title: 'ë³€ê²½ ì™„ë£Œ',
                            text: response.data.msg,
                            icon: "success",
                            confirmButtonColor: '#203e96',
                            confirmButtonText: 'ë‹«ê¸°',
                          });
                        } else {
                          Swal.fire({
                            backdrop: "rgba(255,255,255,0.5)",
                            title: 'ë³€ê²½ ì‹¤íŒ¨',
                            text: response.data.msg,
                            icon: "error",
                            confirmButtonColor: '#203e96',
                            confirmButtonText: 'ë‹«ê¸°',
                          });
                        };
                      });
                    },
                  });
                };
              });
            },
          });
        });
      };
    });
  });
</script>
{% endblock content %}
{% extends 'base.html' %}
{% load static %}
{% load django_bootstrap5 %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'style/post.css' %}">
{% endblock css %}
{% block content %}

<section class="post_back">
  <section class="post__cover">
    <h1 class="post__cover__h1">DM 페이지</h1>
    <div class="post__cover__main">
      <div class="post__cover__main__box">
        <div class="post__cover__main__box__header">
          <h1>받은 편지함</h1>
        </div>
        <hr>
        {% comment %} 받은 DM {% endcomment %}
        {% for note in page_obj %}
        <div class="post__cover__main__box__list" id="{{note.pk}}">
        <button type="button" class="btn modal-btn" data-bs-toggle="modal" data-bs-target="#modal{{note.pk}}" data-note-id="{{note.pk}}" value="{{note.pk}}" onclick="read(event)">
          <div class="post__cover__main__box__modal" data-note-id="{{note.pk}}" value="{{note.pk}}" onclick="read(event)">
            <div style="width:80px;">
              {% if note.from_user.test %}
                {{ note.from_user.creater_name }}
              {% elif note.from_user.creater_name %}
                {{ note.from_user.creater_name }}
              {% else %}
                {{ note.from_user.username }}
              {% endif %}
            </div>  {% comment %} 보낸사람 {% endcomment %}
            <div style="width:120px;">{{ note.title }}</div>
            <div style="width:150px;">{{ note.created_at|date:'o.m.d' }}</div>
            <div style="width:30px;">
              {% if note.read == 0 %}
              <i id="readbool" class="bi bi-check"></i>
              {% else %}
              <i id="readbool" class="bi bi-check-all"></i>
              {% endif %}
            </div>
          </div>
        </button>
        <button class="btn">
          {% csrf_token %}
            <i class="bi bi-trash" data-note-id="{{note.pk}}" value="{{note.pk}}" onclick="remove(event)"></i>
        </button>
        </div>
        {% comment %} 받은 DM 끝 {% endcomment %}
        <!-- Modal -->
        <div class="modal fade" id="modal{{note.pk}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">
                  {% if note.from_user.test %}
                    {{ note.from_user.creater_name }}
                  {% elif note.from_user.creater_name %}
                    {{ note.from_user.creater_name }}
                  {% else %}
                    {{ note.from_user.username }}
                  {% endif %}
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {{ note.title }}
                {{ note.content }}
              </div>
              <div class="modal-footer">
                <a href="{% url 'notes:send' note.from_user.pk %}">
                  <button type="button" class="btn btn-primary">답장하기
                  </button>
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal 끝 -->
        {% endfor %}
        {% comment %} 받은 DM 페이지네이션 {% endcomment %}
        <div class="paginagtion">
          <hr>
          <span class="step-links">
          <ul class="pagination justify-content-center">
            <!-- 이전페이지 -->
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link text-danger" href="?note={{from_name}}{{ page_obj.previous_page_number }}">이전</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" tabindex="-1" aria-disabled="true" href="#">이전</a>
            </li>
            {% endif %}

            {% for page_number in page_obj.paginator.page_range %}
                {% if page_number >= page_obj.number|add:-5 and page_number <= page_obj.number|add:5 %}
                  {% if page_number == page_obj.number %}
                    <li class="page-item active" aria-current="page">
                      <a class="page-link text-bg-danger border-danger" href="?note={{from_name}}{{ page_number }}">{{ page_number }}</a>
                    </li>
                  {% else %}
                    <li class="page-item">
                        <a class="page-link text-danger" href="?note={{from_name}}{{ page_number }}">{{ page_number }}</a>
                    </li>
                  {% endif %}
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link text-danger" href="?note={{from_name}}{{ page_obj.next_page_number }}">다음</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" tabindex="-1" aria-disabled="true" href="#">다음</a>
            </li>
            {% endif %}
          </ul>
          </span>
        </div>
        {% comment %} 받은 DM 페이지네이션 끝 {% endcomment %}
      </div>

      <div class="post__cover__main__box">
        <div class="post__cover__main__box__header">
          <h1>보낸 편지함</h1>
        </div>
        <hr>
        {% comment %} 보낸 DM {% endcomment %}
        {% for to_note in to_page_obj %}
        <div class="post__cover__main__box__list">
        <button type="button" class="btn modal-btn" data-bs-toggle="modal" data-bs-target="#modal{{to_note.text}}">
          <div class="post__cover__main__box__modal" data-note-id="{{note.pk}}" value="{{note.pk}}" onclick="read(event)">
            {% if to_note.from_user.test %}
            <div style="width:80px;">{{ to_note.from_user.creater_name }}</div>
            {% elif to_note.from_user.creater_name %}
            <div style="width:80px;">{{ to_note.from_user.creater_name }}</div>
            {% else %}
            <div style="width:80px;">{{ to_note.from_user.username }}</div>
            {% endif %}
            <div style="width:120px;">{{ to_note.title }}</div>
            <div style="width:150px;">{{ to_note.created_at|date:'o.m.d' }}</div>
            <div style="width:30px;">
              {% if note.read == 0 %}
              <i id="readbool" class="bi bi-check"></i>
              {% else %}
              <i id="readbool" class="bi bi-check-all"></i>
              {% endif %}
            </div>
          </div>
        </button>
      </div>
        {% comment %} 보낸 DM 끝 {% endcomment %}
        <!-- Modal -->
        <div class="modal fade" id="modal{{to_note.text}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">
                  {% if to_note.from_user.test %}
                    {{ to_note.from_user.creater_name }}
                  {% elif to_note.from_user.creater_name %}
                    {{ to_note.from_user.creater_name }}
                  {% else %}
                    {{ to_note.from_user.username }}
                  {% endif %}
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="fw-bold fs-5 mb-1">{{ to_note.title }}</div>
                <div>{{ to_note.content }}</div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal 끝-->
        {% endfor %}
        {% comment %} 보낸 DM 페이지네이션 {% endcomment %}
        <div class="paginagtion">
          <hr>
          <span class="step-links">
          <ul class="pagination justify-content-center">
            <!-- 이전페이지 -->
            {% if to_page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link text-danger" href="?note={{to_name}}{{ to_page_obj.previous_page_number }}">이전</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" tabindex="-1" aria-disabled="true" href="#">이전</a>
            </li>
            {% endif %}

            {% for page_number in to_page_obj.paginator.page_range %}
                {% if page_number >= to_page_obj.number|add:-5 and page_number <= to_page_obj.number|add:5 %}
                  {% if page_number == to_page_obj.number %}
                    <li class="page-item active" aria-current="page">
                      <a class="page-link text-bg-danger border-danger" href="?note={{to_name}}{{ page_number }}">{{ page_number }}</a>
                    </li>
                  {% else %}
                    <li class="page-item">
                        <a class="page-link text-danger" href="?note={{to_name}}{{ page_number }}">{{ page_number }}</a>
                    </li>
                  {% endif %}
                {% endif %}
            {% endfor %}
            
            {% if to_page_obj.has_next %}
            <li class="page-item">
                <a class="page-link text-danger" href="?note={{to_name}}{{ to_page_obj.next_page_number }}">다음</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <a class="page-link" tabindex="-1" aria-disabled="true" href="#">다음</a>
            </li>
            {% endif %}
          </ul>
          </span>
        </div>
        {% comment %} 보낸 DM 페이지네이션 끝 {% endcomment %}
      </div>
    </div>
  </section>
</section>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  function read(event) {
    axios({
      method: 'get',
      url: `/notes/${event.target.dataset.noteId}/detail/`,
      data: {'note_pk': event.target.dataset.noteId},
    })
    .then(response => {
      const div = document.querySelector("#readbool")
      div.className = "bi bi-check-all"
    })
  }

  function remove(event) {
    console.log(event.target.dataset.noteId)
    var delete_warngin = confirm("편지를 삭제하시겠습니까?")
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
    if (delete_warngin == true) {
      axios({
        method: 'post',
        url: `/notes/${event.target.dataset.noteId}/delete/`,
        headers: {'X-CSRFToken': csrftoken},
        data: {'note_pk': event.target.dataset.noteId},
      })
      .then(res => {
        const resdata = res.data.pk
        const div = document.getElementById(resdata)
        console.log(div)
        div.remove()
      })
    }
  }
  </script>

{% endblock content %}

